WITH single_app_users AS (
    SELECT user, app_name
    FROM user_applications
    GROUP BY user, app_name
    HAVING COUNT(app_name) = 1
),
multi_app_users AS (
    SELECT user, app_name
    FROM user_applications
    GROUP BY user, app_name
    HAVING COUNT(app_name) > 1
)
SELECT 
    ua.app_name AS Application,
    COUNT(DISTINCT single_app_users.user) AS Unique_Users,
    ARRAY_JOIN(ARRAY_AGG(DISTINCT single_app_users.user), ', ') AS Unique_User_List,
    COUNT(DISTINCT multi_app_users.user) AS Multi_App_Users,
    ARRAY_JOIN(ARRAY_AGG(DISTINCT multi_app_users.user), ', ') AS Multi_App_User_List
FROM 
    user_applications ua
LEFT JOIN 
    single_app_users 
ON ua.user = single_app_users.user AND ua.app_name = single_app_users.app_name
LEFT JOIN 
    multi_app_users 
ON ua.user = multi_app_users.user AND ua.app_name = multi_app_users.app_name
GROUP BY 
    ua.app_name
ORDER BY 
    ua.app_name;